div.c-table-of-content.c-content
    nav.c-table-of-content-navigation.fixed#table-of-content-nav(role="navigation" aria-label="Table of content")
        ol.c-table-of-content__nav.relativeWidth.stickyPosition(style="top: 3rem;")
            li
                a.c-table-of-content__nav__item(href='#section1' aria-selected="true") Objet du contrat
            li
                a.c-table-of-content__nav__item(href='#section2') Définitions
            li
                a.c-table-of-content__nav__item(href='#section3') Le titulaire
            li
                a.c-table-of-content__nav__item(href='#section4') L'entreprise partagée
            li
                a.c-table-of-content__nav__item(href='#section5') Création et vie d'une Activité
            li
                a.c-table-of-content__nav__item(href='#section6') Droits de l'Entreprise partagée
            li
                a.c-table-of-content__nav__item(href='#section7') Droits du Titulaire
            li
                a.c-table-of-content__nav__item(href='#section8') Exclusion
            li
                a.c-table-of-content__nav__item(href='#section9') Droit & attribution de compétence
            li
                a.c-table-of-content__nav__item(href='#section10') Conclusion
            .current-state(aria-hidden="true")

    div.c-table-of-content__content
        section#section1.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 1
            h3.h3.u-spacer-bottom-xs  Objet du contrat
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section2.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 2
            h3.h3.u-spacer-bottom-xs  Définitions
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section3.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 3
            h3.h3.u-spacer-bottom-xs  Le titulaire
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section4.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 4
            h3.h3.u-spacer-bottom-xs  L'entreprise partagée
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section5.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 5
            h3.h3.u-spacer-bottom-xs  Création et vie d'une Activité
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section6.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 6
            h3.h3.u-spacer-bottom-xs  Droits de l'Entreprise partagée
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section7.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 7
            h3.h3.u-spacer-bottom-xs  Droits du Titulaire
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section8.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 8
            h3.h3.u-spacer-bottom-xs  Exclusion
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section9.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 9
            h3.h3.u-spacer-bottom-xs  Droit et attribution de compétence
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        section#section10.c-table-of-content__content__item.u-spacer-bottom-xl.u-padding-bottom-s
            p.c-body-2.u-spacer-bottom-s Article 10
            h3.h3.u-spacer-bottom-xs  Conclusion
            p Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore.
        .back-to-top
            button.c-button.c-button--secondary.c-button--icon.u-shadow-10
                span.c-button__content
                    +icon('arrow-up')
                    .u-sr-accessible Back to table of content
    script.
        window.addEventListener('load', (event) => {
            class Toc {
                constructor(el) {
                    this.el = el;
                    this.toc__nav__list = this.el.querySelector(".c-table-of-content__nav");
                    this.toc__nav__list__items = this.el.querySelectorAll("a.c-table-of-content__nav__item");
                    this.toc__content__list = document.querySelector(".c-table-of-content__content");
                    this.toc__content__list__items = document.querySelectorAll(".c-table-of-content__content__item");
                    this.current_state = this.el.querySelector(".current-state");
                    this.relativeWidth = (this.toc__nav__list.classList.contains('relativeWidth')) ? true : false;
                    this.toc__back_to_top_btn = this.el.querySelector(".back-to-top");
                    this.toc__back_to_top_btn__link = this.toc__back_to_top_btn.querySelector("button");
                    this.toc__back_to_top_btn__visible = false;
                    this.el_init_top = this.el.getBoundingClientRect().top;
                    this.toc__content__list__items__posTop_from_parent = [];
                    this.lastScrollTop = 0;
                    this.whatever = this.callBackScrollEvent.bind(this, el);
                    this.init();
                }

                init() {
                    this.current_nav_item = this.toc__nav__list.querySelector("[aria-selected]");
                    this.toc__back_to_top_btn.style.display = 'none';

                    //- Set current item selected                 
                    let current_index = [...this.toc__nav__list__items].indexOf(this.current_nav_item)
                    
                    this.resetActiveToc(this.current_nav_item, null, this.toc__content__list__items[current_index]);
                    //- this.scrollTo(this.toc__content__list__items[current_index]); // Scroll directly to aria-selected true

                    this.toc__nav__list__items.forEach((table_of_content__item, i) => {
                        // Attach events to the toc__nav__list__items if the table_of_content__item have toc__content. Otherwise they just act as links
                        table_of_content__item.setAttribute('data-id', this.convertToSlug(table_of_content__item.textContent));
                        this.toc__content__list__items[i].setAttribute('id', this.convertToSlug(table_of_content__item.textContent));
                        if (this.toc__content__list__items.length) this.attachEvents(table_of_content__item, i);
                        
                        if(i === this.toc__nav__list__items.length-1) {
                            this.callback(current_index);
                        }
                    });

                    this.toc__back_to_top_btn__link.addEventListener("click", (e) => {
                        e.preventDefault();
                        this.scrollTo(this.toc__nav__list);
                    });
                    window.addEventListener('hashchange', () => {
                        this.init();
                    });

                }

                attachScrollEvents(){
                    window.addEventListener("scroll", this.whatever);
                }


                callBackScrollEvent(el){
                    let toc__posTop_from_viewport =  this.el.getBoundingClientRect().top - this.el_init_top - 26 - 50; // 126 for header and title fiex, 26 for padding, 50 for a gap
                    let window__posTop_from_viewport = window.scrollY;
                    var st = window.pageYOffset || document.documentElement.scrollTop; 

                    //- Handling back-to-top btn
                    if(- toc__posTop_from_viewport > this.toc__content__list__items__posTop_from_parent[1]){
                        if(this.toc__back_to_top_btn__visible === false){
                            this.fadeIn(this.toc__back_to_top_btn);
                            this.toc__back_to_top_btn__visible = true;
                        }
                    }else{
                        if(this.toc__back_to_top_btn__visible === true){
                            this.fadeOut(this.toc__back_to_top_btn);
                            this.toc__back_to_top_btn__visible = false;
                        }
                    }
                    
                    //- Handling active states on scroll
                    for (let i = 0; i < this.toc__content__list__items__posTop_from_parent.length; i++) {
                            if (st > this.lastScrollTop){
                                //- scrolling-down
                                if ((- toc__posTop_from_viewport) > this.toc__content__list__items__posTop_from_parent[i] && (- toc__posTop_from_viewport) < this.toc__content__list__items__posTop_from_parent[i+1]) {
                                    this.resetActiveToc( this.toc__nav__list__items[i], this.toc__content__list__items[i-1], this.toc__content__list__items[i])
                                }
                            } else {
                                //- scrolling-up
                                if ((- toc__posTop_from_viewport) > this.toc__content__list__items__posTop_from_parent[i] && (- toc__posTop_from_viewport) < this.toc__content__list__items__posTop_from_parent[i+1]) {
                                    this.resetActiveToc( this.toc__nav__list__items[i], this.toc__content__list__items[i+1], this.toc__content__list__items[i])
                                }
                            }
                    }
                    this.lastScrollTop = st <= 0 ? 0 : st;
                }

                callback (current_index) { 
                    this.toc__nav__list__items.forEach((table_of_content__item, i) => {
                        this.toc__content__list__items__posTop_from_parent.push(Math.round(this.toc__content__list__items[i].offsetTop));
                    });
                    this.attachScrollEvents();

                    //- Get # Hashtag from url (ex: lentreprise-partage)
                    let hash = window.top.location.hash.substr(1);
                    if(hash.length){
                        let current_hash_content_item = this.toc__content__list.querySelector("#" + hash);
                        let current_hash_nav_item = document.querySelector('[data-id="' + hash + '"]');
                        this.resetActiveToc(current_hash_nav_item, this.toc__content__list__items[current_index], current_hash_content_item);
                        this.scrollTo(current_hash_content_item);
                    }
                }

                resetActiveToc(newTocNavItem, oldTocContentItem, newTocContentItem){
                    this.positionTopCurrentState(newTocNavItem);
                    for (let i = 0; i < this.toc__nav__list__items.length; i++) {
                        this.toc__nav__list__items[i].removeAttribute("aria-selected");
                    }
                    if (newTocNavItem) newTocNavItem.setAttribute("aria-selected", "true");
                    if (oldTocContentItem) oldTocContentItem.classList.remove("active");
                    if (newTocContentItem) newTocContentItem.classList.add("active");
                }

                attachEvents(table_of_content__item, i) {
                    // Handle clicking of toc__items for mouse users
                    table_of_content__item.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.currentTarget.classList.add("clicked");
                        window.removeEventListener("scroll", this.whatever);
                        let currentToc = this.toc__nav__list.querySelector("[aria-selected]");
                        this.switchToc(currentToc, e.currentTarget);
                    });
                }

                switchToc(oldTocNavItem, newTocNavItem) {
                    newTocNavItem.focus();
                    
                    let index = [...this.toc__nav__list__items].indexOf(newTocNavItem);
                    let oldIndex = [...this.toc__nav__list__items].indexOf(oldTocNavItem);

                    this.resetActiveToc(newTocNavItem, this.toc__content__list__items[oldIndex], this.toc__content__list__items[index]);
                    this.scrollTo(this.toc__content__list__items[index]);
                    var that = this;
                    setTimeout(function(){ 
                        newTocNavItem.classList.remove("clicked");
                    }, 400);
                    setTimeout(function(){ 
                        window.addEventListener("scroll", that.whatever);
                    }, 900);
                }

                positionTopCurrentState(child) {
                    // Position of the blue background
                    let table_of_content_Y = this.toc__nav__list.getBoundingClientRect().top;
                    if(child){
                        let itemHeight = child.clientHeight;
                        let relativePosTop =  child.getBoundingClientRect().top  - table_of_content_Y;
                        this.current_state.style.top = relativePosTop + 'px';
                        console.log(itemHeight);
                        this.current_state.style.height = itemHeight + 'px';
                        if(this.relativeWidth){
                            let childWidth =  child.offsetWidth;
                            this.current_state.style.width = childWidth + 'px';
                        }
                    }
                }

                scrollTo(element) {
                    let parentPosition = this.el.getBoundingClientRect().top + window.scrollY;
                    let elementPosition = element.offsetTop - 55;
                    let offsetPosition = (elementPosition + parentPosition);
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                }

                convertToSlug(str) {
                    str = str.replace(/^\s+|\s+$/g, ''); // trim
                    str = str.toLowerCase();
                
                    // remove accents, swap ñ for n, etc
                    var from = "àáäâèéëêìíïîòóöôùúüûñç·/_,:;";
                    var to   = "aaaaeeeeiiiioooouuuunc------";
                    for (var i=0, l=from.length ; i<l ; i++) {
                        str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
                    }

                    str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
                        .replace(/\s+/g, '-') // collapse whitespace and replace by -
                        .replace(/-+/g, '-'); // collapse dashes

                    return str;
                }

                fadeOut(el) {
                    el.style.opacity = 1;
                    (function fade() {
                        if ((el.style.opacity -= .1) < 0) {
                            el.style.display = "none";
                        } else {
                            requestAnimationFrame(fade);
                        }
                    })();
                };

                fadeIn(el, display) {
                    el.style.opacity = 0;
                    el.style.display = display || "block";
                    (function fade() {
                        var val = parseFloat(el.style.opacity);
                        if (!((val += .1) > 1)) {
                            el.style.opacity = val;
                            requestAnimationFrame(fade);
                        }
                    })();
                };
            }
            
            const toclists = document.querySelectorAll(".c-table-of-content");

            if (toclists.length) {
                [...toclists].map((toclist) => new Toc(toclist));
            }
        });